<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>SMIL Messenger</title>

        <!-- CSS and favicon -->
        <%- include('partials/css.ejs') %>
        <%- include('partials/favicon.ejs') %>
    </head>
    <body onload="buildTable();">
    <!-- <body> -->
        <div class="smil-media-player-background-shade" style="display: none" id="smil_media_player_background_shade"></div>
        <div class="smil-media-player-container" id="smil_media_player_container">
        </div>

        <%- include('partials/navbar.ejs', {page: 'compose', user}) %>

        <div class="sidebar-outside-container">
            <form method="post" id="compose_form">
                <div class="smil-compose-form">
                    <div class="form-group">
                        <label for="recepient">Recepient:</label>
                        <div class="input-group">
                            <!-- cb-test: value -->
                            <input class="form-control" name="recepient" id="recepient" type="email" value="<%= draft ? draft.recepient : ''%>" required/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="recepient">Subject:</label>
                        <div class="input-group">
                            <!-- cb-test: value -->
                            <input class="form-control" name="subject" id="subject" minlength="1" maxlength="100" value="<%= draft ? draft.subject : ''%>" required/>
                        </div>
                    </div>
                </div>
                <div class="smil-compose-form">
                    <div id="smil-table">
                        <!-- <thead>
                                <tr>
                                    <th></th>
                                    <th>Start</th>
                                    <th>Duration</th>
                                    <th>Message</th>
                                    <th></th>
                                </tr>
                            </thead> -->
                            <div class="container-fluid">
                                <div class="row smil-compose-row-header" id="smil-header-row">
                                </div>
                                <div id="smil-element-rows">
                                    <!-- <div class="form-inline"> -->
                                    <!-- <div class="form-group col-sm-10"> -->
                                    <!-- <div class="form-group input-group">    -->

                                </div>
                                <div class="row" style="margin: 10px 0px;">
                                    <div class="col-sm-10"></div>
                                    <div class="col-sm-2"><button type="button" style="font-size: 1.5rem; font-weight: bold;" onclick="addRow()"><i class="fas fa-plus"></i></button></div>
                                </div>
                            </div>
                        </table>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-1 col-md-1 col-lg-2">

                    </div>
                    <div class="col-sm-3 col-md-3 col-lg-2 inner-center">
                        <button type="button" class="btn btn-lg btn-primary" onclick="openVideo()">Preview</button>
                    </div>
                    <div class="col-sm-4 col-md-4 col-lg-2 inner-center">
                        <button type="submit" class="btn btn-lg btn-primary" formaction="/compose-draft">Save Draft</button>
                    </div>
                    <div class="col-sm-3 col-md-3 col-lg-2 inner-center">
                        <button type="submit" class="btn btn-lg btn-primary" formaction="/compose-send">Send</button>
                    </div>
                    <div class="col-sm-1 col-md-1 col-lg-4">

                    </div>
                </div>
                <input name="smil_text" id="smil_text" style="display: none" value="">
                <input id="draft" name="draft" value="" hidden>
            </form>
        </div>

        <!--Scripts-->
        <%- include('partials/scripts.ejs') %>

        <script type="text/javascript">
            var draft = <%- JSON.stringify(draft) %>;
            document.getElementById("draft").value = JSON.stringify(draft);

            var smilMediaPlayerContainer = document.getElementById('smil_media_player_container');
            var mediaPlayer = GetSmilPlayer(smilMediaPlayerContainer);
            mediaPlayer.onClose(()=>{
                document.getElementById('smil_media_player_background_shade').style.display = "none";
            });

            $('#compose_form').submit(function() {
                buildSmilMessage();
                return true;
            });

            function openVideo(){
                var $composeForm = $('#compose_form');
                if (!$composeForm[0].checkValidity()){
                    $composeForm[0].reportValidity();
                    return;
                }
                buildSmilMessage();
                let message = document.getElementById("smil_text").value;
                let subject = document.getElementById("subject").value;
                let from = "<%= user.email %>";
                console.log(message);

                let videoTitle = 
                `
                From: ${from}<br>
                Subject: ${subject}
                `;                
                
                console.log(`Message is ${message}`);
                let opened = mediaPlayer.open(message, videoTitle); 
                if(opened){ 
                    document.getElementById('smil_media_player_background_shade').style.display="block";  
                }    
            }

            function onPressTest(){
                buildSmilMessage();
            }
            var row_count = 0;

            console.log("row_count:" + row_count)

            function buildTable() {
                if(draft !== null) {
                    console.log("draft received");
                    console.log(draft.recepient);
                    console.log(draft);
                    for(let i = 0; i < draft.elements.length; i++){
                        addRow(draft.elements[i].begin, draft.elements[i].dur, draft.elements[i].txt);
                    }
                } else {
                    console.log("draft not received");
                    addRow();
                }

                addHeader();
            }
            
            function addHeader() {
              document.querySelector('#smil-header-row').insertAdjacentHTML(
                'beforeend',
                `
                    <div class="col-sm-2">Start</div>
                    <div class="col-sm-2">Duration</div>
                    <div class="col-sm-7">Message</div>
                    <div class="col-sm-1"></div>
                ` 
                )
            }


            function addRow(begin = "", dur = "", message = "") {
              document.querySelector('#smil-element-rows').insertAdjacentHTML(
                'beforeend',
                `<div class="row" style="margin: 10px 0px;">
                    <div id="input-group#${row_count}" class="input-group">
                        <div class="col-sm-2"><input class="form-control" name="elem[${row_count}][begin]" type="number" min="0" max="60" value="${begin}" required/></div>
                        <div class="col-sm-2"><input class="form-control" name="elem[${row_count}][dur]" type="number" min="1" max="30" value="${dur}" required/></div>
                        <div class="col-sm-6"><input type="text" class="form-control" name="elem[${row_count}][txt]" rows="1" minlength="1" maxlength="100" value="${message}" required/></input></div>
                        <div class="col-sm-2"><button type="button" onclick="removeRow(this)" style="font-size: 1.5rem; font-weight: bold;"><i class="far fa-trash-alt"></i></button></div>
                    </div>
                </div>`
              )
              row_count++;
              console.log("row_count:" + row_count)
            }

            function removeRow (input) {
                console.log(input);
                var parent = input.parentNode.parentNode.parentNode;
                console.log(parent);
              var group_id = input.parentNode.parentNode.id;
              console.log(`group id is ${group_id}`);
              var start_pos = group_id.indexOf("#")
              var group_id_len = group_id.length
              var group_id_num = group_id.substring(start_pos+1, group_id_len)

              console.log("row_count:" + row_count)
              if (row_count > 1)
              {
                input.parentNode.parentNode.parentNode.remove()
                row_count--;
                console.log("row_count:" + row_count)
              }
            }
        </script>
    </body>
</html>